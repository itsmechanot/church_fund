{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Profile - Parish Core</title>
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <a class="back-button" href="{% url 'index' %}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </svg>
        Home
    </a>

    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">
                <img src="{% static 'img/profile.jpg' %}" alt="Logo">
            </div>
            <div class="profile-info">
                <h1>{{ treasurer.get_full_name }}</h1>
                <span class="profile-role">{{ treasurer.position }}</span>
                <p class="profile-branch">
                    <i class="fas fa-church"></i>
                    {{ treasurer.church_branch|default:"No branch assigned" }}
                </p>
            </div>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}error{% else %}success{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="profile-content">
            <div class="profile-section">
                <h2>
                    <i class="fas fa-user-edit"></i>
                    Personal Information
                </h2>
                <form method="POST" class="profile-form">
                    {% csrf_token %}

                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_first_name">First Name</label>
                            {{ form.first_name }}
                        </div>
                        <div class="form-group">
                            <label for="id_last_name">Last Name</label>
                            {{ form.last_name }}
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_age">Age</label>
                            {{ form.age }}
                        </div>
                        <div class="form-group">
                            <label for="id_sex">Sex</label>
                            {{ form.sex }}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_email">Email Address</label>
                        {{ form.email }}
                    </div>

                    <div class="form-group">
                        <label for="id_phone_number">Phone Number</label>
                        {{ form.phone_number }}
                    </div>

                    <div class="form-group">
                        <label for="id_church_branch">Church Branch</label>
                        {{ form.church_branch }}
                    </div>

                    <button type="submit" class="submit-btn">Update Profile</button>
                </form>
            </div>

            <div class="stats-section">
                <h2>
                    <i class="fas fa-chart-bar"></i>
                    Work Statistics
                </h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Funds Managed</h3>
                            <p class="stat-number">₱{{ total_managed_funds|floatformat:2|intcomma }}</p>
                            <p class="stat-desc">Across all funds</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Transactions Created</h3>
                            <p class="stat-number">{{ current_month_transaction_count }}</p>
                            <p class="stat-desc">This month (by you)</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Fund Growth</h3>
                            <p class="stat-number 
                                {% if growth_percentage > 0 %}text-success{% elif growth_percentage < 0 %}text-danger{% endif %}">
                                
                                {% if growth_percentage > 0 %}
                                    <i class="fas fa-arrow-up"></i>
                                {% elif growth_percentage < 0 %}
                                    <i class="fas fa-arrow-down"></i>
                                {% else %}
                                    <i class="fas fa-minus"></i>
                                {% endif %}
                                
                                {{ growth_percentage|floatformat:2 }}%
                            </p>
                            <p class="stat-desc">Last 30 days</p>
                        </div>
                    </div>
                
                    <div class="stat-card recent-card">
                        <div class="stat-icon">
                            <i class="fas fa-list-alt"></i> 
                        </div>
                        <div class="stat-info">
                            <h3>Recent Transactions</h3>
                            {% if recent_transactions %}
                            <ul class="recent-list">
                                {% for transaction in recent_transactions|slice:":4" %} 
                                <li class="list-item transaction-{{ transaction.transaction_type|lower }}">
                                    <span class="list-type">{{ transaction.transaction_type|title|slice:":8" }}</span>
                                    
                                    <span class="list-amount">
                                        {% if transaction.transaction_type == 'OFFERING' %}+{% else %}-{% endif %}
                                        ₱{{ transaction.amount|floatformat:0|intcomma }}
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="no-data-message">No recent transactions.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            
                <div class="chart-container">
                    <h3>Monthly Fund Activity</h3>
                    <canvas id="fundChart"></canvas>
                </div>
            </div>
        </div>

        <div class="account-section">
            <h3>Account Information</h3>
            <div class="account-info">
                <div class="info-item">
                    <strong>Username:</strong>
                    {{ treasurer.username }}
                </div>
                <div class="info-item">
                    <strong>Member since:</strong>
                    {{ treasurer.date_joined|date:"F d, Y" }}
                </div>
                <div class="info-item">
                    <strong>Last login:</strong>
                    {{ treasurer.last_login|date:"F d, Y H:i"|default:"Never" }}
                </div>
            </div>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('fundChart').getContext('2d');
        const fundChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                data: [12000, 19000, 15000, 25000, 22000, 30000], // Static data for now
                datasets: [{
                    label: 'Fund Balance',
                    data: [12000, 19000, 15000, 25000, 22000, 30000],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#007bff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            font: {
                                size: 13,
                                weight: '600'
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return '₱' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>

</html>